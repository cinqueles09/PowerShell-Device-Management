name: Update Subfolder READMEs with PowerShell Descriptions

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * *'  # todos los dÃ­as a las 05:00 UTC

permissions:
  contents: write

jobs:
  update-subreadmes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Generate and update READMEs
        run: |
          echo "ðŸ” Buscando subcarpetas con scripts PowerShell..."

          EXCLUDE_DIRS=".git .github"

          for dir in */ ; do
            dir=${dir%/}
            if [[ " $EXCLUDE_DIRS " =~ " $dir " ]]; then
              continue
            fi

            # Buscar scripts PowerShell en la carpeta
            scripts=$(find "$dir" -maxdepth 1 -type f -name "*.ps1" 2>/dev/null)

            if [ -z "$scripts" ]; then
              echo "ðŸš« No hay scripts en $dir"
              continue
            fi

            echo "ðŸ§© Actualizando README en $dir"

            OUTPUT="### ðŸ“œ Scripts en ${dir}\n\n"

            for file in $scripts; do
              name=$(basename "$file")

              # Extraer la secciÃ³n .DESCRIPTION del encabezado <# ... #>
              desc=$(awk '
                BEGIN {capture=0; description=""}
                /^\s*<#/ {capture=1; next}
                /^\s*#>/ {capture=0; next}
                capture && /^\s*\.DESCRIPTION/i {flag=1; next}
                capture && flag {if ($0 ~ /^\s*\./) {flag=0} else {description=description $0 "\n"}}
                END {gsub(/\n+$/, "", description); print description}
              ' "$file")

              if [ -z "$desc" ]; then
                desc="(sin descripciÃ³n)"
              fi

              # Agregar al listado
              OUTPUT+="- **${name}** â†’ ${desc}\n"
            done

            README="${dir}/README.md"

            # Crear README si no existe
            if [ ! -f "$README" ]; then
              echo "# ${dir}" > "$README"
              echo "" >> "$README"
            fi

            # Asegurar marcadores
            START="<!-- SCRIPTS_SECTION_START -->"
            END="<!-- SCRIPTS_SECTION_END -->"
            if ! grep -q "$START" "$README"; then
              echo -e "\n## ðŸ“œ Scripts\n$START\n$END" >> "$README"
            fi

            # Sustituir bloque entre marcadores
            awk -v start="$START" -v end="$END" -v content="$OUTPUT" '
              $0 ~ start {print; print co
