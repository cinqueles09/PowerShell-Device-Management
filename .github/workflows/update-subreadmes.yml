name: Update Subfolder READMEs with Script Descriptions

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 4 * * *'

permissions:
  contents: write

jobs:
  update-subreadmes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create Python extractor for .DESCRIPTION
        shell: bash
        run: |
          cat <<'PY' > /tmp/extract_desc.py
#!/usr/bin/env python3
import re
import sys

def extract_description(path):
    try:
        with open(path, "r", encoding="utf-8") as f:
            text = f.read()
        # Buscar bloque de comentarios <# ... #>
        m = re.search(r"<#(.*?)#>", text, re.DOTALL)
        if not m:
            return ""
        block = m.group(1)
        # Buscar .DESCRIPTION (may√∫sculas o min√∫sculas)
        m2 = re.search(r"(?i)\.DESCRIPTION\s*(.*?)(\n\s*\.[A-Z]|$)", block, re.DOTALL)
        if not m2:
            return ""
        desc = " ".join(line.strip() for line in m2.group(1).splitlines() if line.strip())
        return desc.strip()
    except Exception as e:
        return f"(error al leer: {e})"

if __name__ == "__main__":
    if len(sys.argv) > 1:
        print(extract_description(sys.argv[1]))
PY
          chmod +x /tmp/extract_desc.py

      - name: Update subfolder READMEs
        shell: bash
        run: |
          echo "üîç Buscando subcarpetas con scripts PowerShell..."
          EXCLUDE_DIRS=".git .github"

          for dir in */; do
            dir="${dir%/}"
            [[ " $EXCLUDE_DIRS " =~ " $dir " ]] && continue

            mapfile -t scripts < <(find "$dir" -maxdepth 1 -type f -name "*.ps1" 2>/dev/null)
            if [ ${#scripts[@]} -eq 0 ]; then
              echo "üö´ No hay scripts en $dir"
              continue
            fi

            echo "üìÇ Procesando carpeta: $dir"
            SECTION=""

            for script in "${scripts[@]}"; do
              name=$(basename "$script")
              desc=$(/tmp/extract_desc.py "$script")
              [[ -z "$desc" ]] && desc="(sin descripci√≥n)"
              SECTION+="- **${name}** ‚Üí ${desc}\n"
            done

            START="<!-- SCRIPTS_SECTION_START -->"
            END="<!-- SCRIPTS_SECTION_END -->"
            README="$dir/README.md"

            if [ ! -f "$README" ]; then
              echo "# $dir" > "$README"
              echo "" >> "$README"
              echo "## üìú Scripts" >> "$README"
              echo "$START" >> "$README"
              echo "$END" >> "$README"
            fi

            awk -v start="$START" -v end="$END" -v content="$SECTION" '
              $0 ~ start {print; print content; skip=1; next}
              $0 ~ end {skip=0}
              !skip {print}
            ' "$README" > temp && mv temp "$README"

            echo "‚úÖ Actualizado: $dir/README.md"
          done

      - name: Commit and push if changes exist
        run: |
          git add */README.md
          if git diff --cached --quiet; then
            echo "‚úÖ No hay cambios que guardar."
            exit 0
          fi
          git commit -m "üîÑ Actualizaci√≥n autom√°tica de descripciones en subcarpetas [skip ci]"
          git push origin HEAD:main
