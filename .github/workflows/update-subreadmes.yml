name: Test PowerShell Description Extraction

on:
  workflow_dispatch:  # ejecuci贸n manual desde la pesta帽a "Actions"

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Detect subfolders and extract .DESCRIPTION
        run: |
          echo " Buscando subcarpetas con scripts PowerShell..."
          EXCLUDE_DIRS=".git .github"

          for dir in */ ; do
            dir="${dir%/}"
            [[ " $EXCLUDE_DIRS " =~ " $dir " ]] && continue

            echo " Carpeta: $dir"
            mapfile -t scripts < <(find "$dir" -maxdepth 1 -type f -name "*.ps1")

            if [ ${#scripts[@]} -eq 0 ]; then
              echo "   No hay scripts en $dir"
              continue
            fi

            for file in "${scripts[@]}"; do
              echo "  З Script: $file"

              # Extraer .DESCRIPTION usando Python de forma segura
              desc=$(python3 - "$file" <<'PYTHON'
import re, sys
file = sys.argv[1]
desc = ""
with open(file, "r", encoding="utf-8") as f:
    content = f.read()
    m = re.search(r"<#(.*?)#>", content, re.DOTALL)
    if m:
        block = m.group(1)
        m2 = re.search(r"(?i)\.DESCRIPTION\s*(.*?)(\n\s*\.|$)", block, re.DOTALL)
        if m2:
            desc = " ".join(line.strip() for line in m2.group(1).splitlines() if line.strip())
print(desc.strip())
PYTHON
 "$file")

              if [ -z "$desc" ]; then
                echo "    锔  No se encontr贸 descripci贸n."
              else
                echo "     Descripci贸n: $desc"
              fi
            done
          done
