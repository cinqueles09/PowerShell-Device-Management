name: Test PowerShell Description Extraction (robusto)

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Create temporary Python extractor
        run: |
          cat > /tmp/extract_desc.py <<'PY'
#!/usr/bin/env python3
import re
import sys
file = sys.argv[1]
desc = ""
try:
    with open(file, "r", encoding="utf-8") as f:
        content = f.read()
        m = re.search(r"<#(.*?)#>", content, re.DOTALL)
        if m:
            block = m.group(1)
            m2 = re.search(r"(?i)\\.DESCRIPTION\\s*(.*?)(\\n\\s*\\.|$)", block, re.DOTALL)
            if m2:
                desc = " ".join(line.strip() for line in m2.group(1).splitlines() if line.strip())
except Exception as e:
    # Si hay error, lo imprimimos por stderr y devolvemos cadena vac铆a
    sys.stderr.write(f'ERROR reading {file}: {e}\\n')
print(desc.strip())
PY
          chmod +x /tmp/extract_desc.py

      - name: Detect subfolders and extract .DESCRIPTION
        run: |
          echo " Buscando subcarpetas con scripts PowerShell..."
          EXCLUDE_DIRS=".git .github"

          for dir in */ ; do
            dir="${dir%/}"
            [[ " $EXCLUDE_DIRS " =~ " $dir " ]] && continue

            echo " Carpeta: $dir"
            # find puede devolver nada; usamos array seguro
            mapfile -t scripts < <(find "$dir" -maxdepth 1 -type f -name "*.ps1" 2>/dev/null)

            if [ ${#scripts[@]} -eq 0 ]; then
              echo "   No hay scripts en $dir"
              continue
            fi

            for file in "${scripts[@]}"; do
              echo "  З Script: $file"
              desc=$(/tmp/extract_desc.py "$file" 2>&1)
              # Si el extractor devolvi贸 algo en stderr, lo ver谩 el log; tratamos la salida
              # Para distinguir errores reales, podr铆as filtrar l铆neas que empiecen por 'ERROR'
              if [ -z "$desc" ]; then
                echo "    锔  No se encontr贸 descripci贸n."
              else
                echo "     Descripci贸n: $desc"
              fi
            done
          done
