name: Update Subfolder READMEs with PowerShell Descriptions

on:
  push:
    branches: [ main ]
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * *'  # todos los d√≠as a las 05:00 UTC

permissions:
  contents: write

jobs:
  update-subreadmes:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update subfolder READMEs
        run: |
          echo "üîç Buscando subcarpetas con scripts PowerShell..."
          EXCLUDE_DIRS=".git .github"

          for dir in */ ; do
            dir="${dir%/}"
            [[ " $EXCLUDE_DIRS " =~ " $dir " ]] && continue

            mapfile -t scripts < <(find "$dir" -maxdepth 1 -type f -name "*.ps1")
            if [ ${#scripts[@]} -eq 0 ]; then
              echo "üö´ No hay scripts en '$dir'"
              continue
            fi

            echo "üß© Actualizando README en '$dir'"

            OUTPUT="### üìú Scripts en ${dir}\n\n"

            for file in "${scripts[@]}"; do
              name=$(basename "$file")

              # Extraer .DESCRIPTION usando Python seguro
              desc=$(python3 - "$file" <<'PYTHON'
import re, sys

file = sys.argv[1]
desc = ""

with open(file, "r", encoding="utf-8") as f:
    content = f.read()
    m = re.search(r"<#(.*?)#>", content, re.DOTALL)
    if m:
        block = m.group(1)
        m2 = re.search(r"(?i)\.DESCRIPTION\s*(.*?)(\n\s*\.|$)", block, re.DOTALL)
        if m2:
            desc = " ".join(line.strip() for line in m2.group(1).splitlines() if line.strip())

print(desc.strip())
PYTHON
 "$file")

              [ -z "$desc" ] && desc="(sin descripci√≥n)"
              OUTPUT+="- **${name}** ‚Üí ${desc}\n"
            done

            README="${dir}/README.md"
            START="<!-- SCRIPTS_SECTION_START -->"
            END="<!-- SCRIPTS_SECTION_END -->"

            # Crear README si no existe
            if [ ! -f "$README" ]; then
              echo "# ${dir}" > "$README"
              echo "" >> "$README"
            fi

            # Crear marcadores si no existen
            if ! grep -q "$START" "$README"; then
              echo -e "\n## üìú Scripts\n$START\n$END" >> "$README"
            fi

            # Sustituir bloque entre marcadores
            awk -v start="$START" -v end="$END" -v content="$OUTPUT" '
              $0 ~ start {print; print content; skip=1; next}
              $0 ~ end {skip=0}
              !skip {print}
            ' "$README" > temp && mv temp "$README"
          done

      - name: Commit and push if changed
        run: |
          git add */README.md
          if git diff --cached --quiet; then
            echo "‚úÖ No hay cambios que guardar."
            exit 0
          fi
          git commit -m "üîÑ Actualizaci√≥n autom√°tica de README de subcarpetas con .DESCRIPTION [skip ci]"
          git push origin HEAD:main
